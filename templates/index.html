<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Forge - 3D模型生成平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/three@0.150.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.150.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/three@0.150.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
        }
        .card-gradient {
            background: linear-gradient(180deg, rgba(30, 58, 95, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
        }
        .glow-border {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        .step-active {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        }
        .step-completed {
            background: #10b981;
        }
        .step-pending {
            background: #374151;
        }
        #model-viewer {
            width: 100%;
            height: 400px;
            background: #0f172a;
            border-radius: 0.5rem;
        }
        .loader {
            border: 3px solid #374151;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                Model Forge
            </h1>
            <p class="text-gray-400">需求描述 → AI Prompt → 图像生成 → 3D模型</p>
        </header>

        <!-- Main Content -->
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Left: Input Form -->
            <div class="card-gradient rounded-xl p-6 glow-border">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    设备描述
                </h2>

                <form id="generate-form" class="space-y-4">
                    <!-- Description -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">需求描述 *</label>
                        <textarea
                            id="description"
                            rows="4"
                            class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                            placeholder="描述您想要生成的设备，例如：一台220kV的油浸式电力变压器，具有三个高压套管、波纹散热翅片和储油柜..."
                            required
                        ></textarea>
                    </div>

                    <!-- Equipment Type & Voltage -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">设备类型</label>
                            <select id="equipment-type" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none">
                                <option value="">自动识别</option>
                                <option value="变压器">变压器</option>
                                <option value="断路器">断路器</option>
                                <option value="发电机">发电机</option>
                                <option value="母线">母线</option>
                                <option value="绝缘子">绝缘子</option>
                                <option value="避雷器">避雷器</option>
                                <option value="输电杆塔">输电杆塔</option>
                                <option value="电流互感器">电流互感器</option>
                                <option value="电压互感器">电压互感器</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">电压等级</label>
                            <select id="voltage-level" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none">
                                <option value="">自动识别</option>
                                <option value="10kV">10kV</option>
                                <option value="35kV">35kV</option>
                                <option value="110kV">110kV</option>
                                <option value="220kV">220kV</option>
                                <option value="500kV">500kV</option>
                                <option value="1000kV">1000kV (特高压)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Mesh Quality -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">模型精度</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label class="cursor-pointer">
                                <input type="radio" name="mesh-quality" value="low" class="sr-only peer">
                                <div class="border border-gray-700 rounded-lg p-3 text-center peer-checked:border-blue-500 peer-checked:bg-blue-500/20 transition">
                                    <div class="font-medium">低精度</div>
                                    <div class="text-xs text-gray-500">~10k面</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="mesh-quality" value="medium" class="sr-only peer" checked>
                                <div class="border border-gray-700 rounded-lg p-3 text-center peer-checked:border-blue-500 peer-checked:bg-blue-500/20 transition">
                                    <div class="font-medium">中等精度</div>
                                    <div class="text-xs text-gray-500">~30k面</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="mesh-quality" value="high" class="sr-only peer">
                                <div class="border border-gray-700 rounded-lg p-3 text-center peer-checked:border-blue-500 peer-checked:bg-blue-500/20 transition">
                                    <div class="font-medium">高精度</div>
                                    <div class="text-xs text-gray-500">~50k面</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button
                        type="submit"
                        id="submit-btn"
                        class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-4 rounded-lg transition transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                    >
                        <span id="btn-text">开始生成 3D 模型</span>
                        <span id="btn-loading" class="hidden">
                            <svg class="animate-spin inline w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            处理中...
                        </span>
                    </button>
                </form>

                <!-- Progress Steps -->
                <div id="progress-section" class="mt-8 hidden">
                    <h3 class="text-sm text-gray-400 mb-4">生成进度</h3>
                    <div class="space-y-3">
                        <div class="flex items-center" id="step-prompt">
                            <div class="w-8 h-8 rounded-full step-pending flex items-center justify-center mr-3 transition-all">
                                <span class="text-sm">1</span>
                            </div>
                            <div>
                                <div class="font-medium">生成Prompt</div>
                                <div class="text-sm text-gray-500" id="step-prompt-status">等待中</div>
                            </div>
                        </div>
                        <div class="flex items-center" id="step-image">
                            <div class="w-8 h-8 rounded-full step-pending flex items-center justify-center mr-3 transition-all">
                                <span class="text-sm">2</span>
                            </div>
                            <div>
                                <div class="font-medium">生成图像</div>
                                <div class="text-sm text-gray-500" id="step-image-status">等待中</div>
                            </div>
                        </div>
                        <div class="flex items-center" id="step-model">
                            <div class="w-8 h-8 rounded-full step-pending flex items-center justify-center mr-3 transition-all">
                                <span class="text-sm">3</span>
                            </div>
                            <div>
                                <div class="font-medium">生成3D模型</div>
                                <div class="text-sm text-gray-500" id="step-model-status">等待中</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Preview -->
            <div class="card-gradient rounded-xl p-6 glow-border">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    预览
                </h2>

                <!-- Tabs -->
                <div class="flex space-x-2 mb-4">
                    <button onclick="switchTab('prompt')" id="tab-prompt" class="px-4 py-2 rounded-lg bg-gray-800/50 text-sm hover:bg-gray-700/50 transition tab-btn">Prompt</button>
                    <button onclick="switchTab('image')" id="tab-image" class="px-4 py-2 rounded-lg bg-gray-800/50 text-sm hover:bg-gray-700/50 transition tab-btn">图像</button>
                    <button onclick="switchTab('model')" id="tab-model" class="px-4 py-2 rounded-lg bg-blue-500/20 border border-blue-500 text-sm transition tab-btn active">3D模型</button>
                </div>

                <!-- Prompt Preview -->
                <div id="preview-prompt" class="hidden">
                    <div class="bg-gray-800/50 rounded-lg p-4 h-[400px] overflow-auto">
                        <pre id="prompt-content" class="text-sm text-gray-300 whitespace-pre-wrap">生成后将在此显示 Prompt...</pre>
                    </div>
                </div>

                <!-- Image Preview -->
                <div id="preview-image" class="hidden">
                    <div class="bg-gray-800/50 rounded-lg p-4 h-[400px] flex items-center justify-center">
                        <img id="image-preview" src="" alt="Generated Image" class="max-h-full max-w-full rounded hidden">
                        <div id="image-placeholder" class="text-gray-500 text-center">
                            <svg class="w-16 h-16 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p>生成后将在此显示图像</p>
                        </div>
                    </div>
                </div>

                <!-- 3D Model Preview -->
                <div id="preview-model">
                    <div id="model-viewer">
                        <div id="model-placeholder" class="w-full h-full flex items-center justify-center text-gray-500">
                            <div class="text-center">
                                <svg class="w-16 h-16 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                                <p>生成后将在此显示3D模型</p>
                                <p class="text-sm mt-1">支持鼠标拖拽旋转、滚轮缩放</p>
                            </div>
                        </div>
                    </div>
                    <div id="model-controls" class="mt-4 hidden">
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-400">
                                <span id="model-info"></span>
                            </div>
                            <button onclick="downloadModel()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm transition">
                                下载模型
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Jobs -->
        <div class="mt-8 card-gradient rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4">历史记录</h2>
            <div id="jobs-list" class="grid md:grid-cols-3 gap-4">
                <div class="text-gray-500 text-center py-8">暂无历史记录</div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentJobId = null;
        let currentModelUrl = null;
        let scene, camera, renderer, controls, model;

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500/20', 'border', 'border-blue-500');
                btn.classList.add('bg-gray-800/50');
            });
            document.getElementById(`tab-${tab}`).classList.add('bg-blue-500/20', 'border', 'border-blue-500');
            document.getElementById(`tab-${tab}`).classList.remove('bg-gray-800/50');

            document.getElementById('preview-prompt').classList.add('hidden');
            document.getElementById('preview-image').classList.add('hidden');
            document.getElementById('preview-model').classList.add('hidden');
            document.getElementById(`preview-${tab}`).classList.remove('hidden');
        }

        // Form submission
        document.getElementById('generate-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const description = document.getElementById('description').value;
            const equipmentType = document.getElementById('equipment-type').value;
            const voltageLevel = document.getElementById('voltage-level').value;
            const meshQuality = document.querySelector('input[name="mesh-quality"]:checked').value;

            // Update UI
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('btn-text').classList.add('hidden');
            document.getElementById('btn-loading').classList.remove('hidden');
            document.getElementById('progress-section').classList.remove('hidden');
            resetSteps();

            try {
                // Start generation
                const response = await fetch('/api/v1/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description,
                        equipment_type: equipmentType || null,
                        voltage_level: voltageLevel || null,
                        mesh_quality: meshQuality
                    })
                });

                const result = await response.json();
                currentJobId = result.job_id;

                // Poll for status
                pollJobStatus(currentJobId);
            } catch (error) {
                alert('请求失败: ' + error.message);
                resetForm();
            }
        });

        // Poll job status
        async function pollJobStatus(jobId) {
            try {
                const response = await fetch(`/api/v1/jobs/${jobId}`);
                const status = await response.json();

                updateProgress(status);

                if (status.stage === 'completed') {
                    onJobCompleted(status);
                } else if (status.stage === 'failed') {
                    alert('生成失败: ' + status.error);
                    resetForm();
                } else {
                    setTimeout(() => pollJobStatus(jobId), 2000);
                }
            } catch (error) {
                console.error('Status poll error:', error);
                setTimeout(() => pollJobStatus(jobId), 3000);
            }
        }

        // Update progress UI
        function updateProgress(status) {
            const stage = status.stage;

            // Update prompt step
            if (stage === 'prompt_generation' || stage === 'image_generation' || stage === 'model_generation' || stage === 'completed') {
                setStepStatus('prompt', stage === 'prompt_generation' ? 'active' : 'completed');
                if (status.prompt) {
                    document.getElementById('prompt-content').textContent = status.prompt;
                }
            }

            // Update image step
            if (stage === 'image_generation' || stage === 'model_generation' || stage === 'completed') {
                setStepStatus('image', stage === 'image_generation' ? 'active' : 'completed');
            }

            // Update model step
            if (stage === 'model_generation' || stage === 'completed') {
                setStepStatus('model', stage === 'model_generation' ? 'active' : 'completed');
            }

            // Update status text
            document.getElementById(`step-${getStepName(stage)}-status`).textContent = status.message || stage;
        }

        function getStepName(stage) {
            if (stage.includes('prompt')) return 'prompt';
            if (stage.includes('image')) return 'image';
            return 'model';
        }

        function setStepStatus(step, status) {
            const stepEl = document.querySelector(`#step-${step} > div:first-child`);
            stepEl.classList.remove('step-pending', 'step-active', 'step-completed');
            stepEl.classList.add(`step-${status}`);

            if (status === 'completed') {
                stepEl.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
            }
        }

        function resetSteps() {
            ['prompt', 'image', 'model'].forEach((step, i) => {
                const stepEl = document.querySelector(`#step-${step} > div:first-child`);
                stepEl.classList.remove('step-active', 'step-completed');
                stepEl.classList.add('step-pending');
                stepEl.innerHTML = `<span class="text-sm">${i + 1}</span>`;
                document.getElementById(`step-${step}-status`).textContent = '等待中';
            });
        }

        function resetForm() {
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('btn-text').classList.remove('hidden');
            document.getElementById('btn-loading').classList.add('hidden');
        }

        // Job completed
        async function onJobCompleted(status) {
            resetForm();

            // Show prompt
            if (status.prompt) {
                document.getElementById('prompt-content').textContent = status.prompt;
            }

            // Show image
            if (status.image_path) {
                const imgUrl = `/api/v1/jobs/${status.job_id}/image`;
                document.getElementById('image-preview').src = imgUrl;
                document.getElementById('image-preview').classList.remove('hidden');
                document.getElementById('image-placeholder').classList.add('hidden');
            }

            // Load 3D model
            if (status.model_files && status.model_files.length > 0) {
                const glbFile = status.model_files.find(f => f.name.endsWith('.glb'));
                if (glbFile) {
                    const fileName = glbFile.name.split('/').pop();
                    currentModelUrl = `/api/v1/jobs/${status.job_id}/model/${fileName}`;
                    load3DModel(currentModelUrl);
                    document.getElementById('model-info').textContent = `文件: ${fileName} (${(glbFile.size_bytes / 1024 / 1024).toFixed(1)} MB)`;
                    document.getElementById('model-controls').classList.remove('hidden');
                }
            }

            // Refresh job list
            loadJobsList();
        }

        // 3D Model Viewer
        function init3DViewer() {
            const container = document.getElementById('model-viewer');
            const width = container.clientWidth;
            const height = container.clientHeight;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f172a);

            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(5, 3, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight2.position.set(-5, -10, -7.5);
            scene.add(directionalLight2);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer && scene && camera) renderer.render(scene, camera);
        }

        function load3DModel(url) {
            document.getElementById('model-placeholder').classList.add('hidden');

            if (!renderer) {
                init3DViewer();
                document.getElementById('model-viewer').appendChild(renderer.domElement);
            }

            // Remove old model
            if (model) {
                scene.remove(model);
            }

            const loader = new THREE.GLTFLoader();
            loader.load(url, (gltf) => {
                model = gltf.scene;

                // Center and scale model
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());

                model.position.sub(center);
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 3 / maxDim;
                model.scale.setScalar(scale);

                scene.add(model);

                // Adjust camera
                camera.position.set(5, 3, 5);
                controls.target.set(0, 0, 0);
                controls.update();
            }, undefined, (error) => {
                console.error('Error loading model:', error);
            });
        }

        function downloadModel() {
            if (currentModelUrl) {
                const a = document.createElement('a');
                a.href = currentModelUrl;
                a.download = 'model.glb';
                a.click();
            }
        }

        // Load jobs list
        async function loadJobsList() {
            try {
                const response = await fetch('/api/v1/jobs');
                const jobs = await response.json();

                if (jobs.length === 0) {
                    document.getElementById('jobs-list').innerHTML = '<div class="text-gray-500 text-center py-8 col-span-3">暂无历史记录</div>';
                    return;
                }

                const html = jobs.slice(0, 6).map(job => `
                    <div class="bg-gray-800/50 rounded-lg p-4 cursor-pointer hover:bg-gray-700/50 transition" onclick="loadJob('${job.job_id}')">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-mono text-gray-400">#${job.job_id}</span>
                            <span class="text-xs px-2 py-1 rounded ${job.stage === 'completed' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">
                                ${job.stage === 'completed' ? '完成' : job.stage}
                            </span>
                        </div>
                        <p class="text-sm text-gray-300 line-clamp-2">${job.description}</p>
                        <p class="text-xs text-gray-500 mt-2">${new Date(job.created_at).toLocaleString()}</p>
                    </div>
                `).join('');

                document.getElementById('jobs-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        async function loadJob(jobId) {
            try {
                const response = await fetch(`/api/v1/jobs/${jobId}`);
                const status = await response.json();
                onJobCompleted(status);
            } catch (error) {
                console.error('Error loading job:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadJobsList();
        });
    </script>
</body>
</html>
