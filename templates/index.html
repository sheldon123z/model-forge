<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Forge - AI 3D模型生成平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/three@0.150.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.150.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/three@0.150.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); }
        .card-gradient { background: linear-gradient(180deg, rgba(30, 58, 95, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%); }
        .glow-border { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .step-active { background: linear-gradient(90deg, #3b82f6, #8b5cf6); }
        .step-completed { background: #10b981; }
        .step-pending { background: #374151; }
        #model-viewer { width: 100%; height: 400px; background: #0f172a; border-radius: 0.5rem; }
        .loader { border: 3px solid #374151; border-top: 3px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
        .progress-bar { transition: width 0.3s ease; }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-in { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                Model Forge 2.0
            </h1>
            <p class="text-gray-400">AI驱动的3D模型生成平台 | 多服务商支持 | 联想批量生成</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center mb-8 space-x-4">
            <button onclick="switchMainTab('single')" id="nav-single" class="px-6 py-3 rounded-lg bg-blue-500/20 border border-blue-500 text-sm font-medium transition nav-btn">
                单个生成
            </button>
            <button onclick="switchMainTab('batch')" id="nav-batch" class="px-6 py-3 rounded-lg bg-gray-800/50 text-sm font-medium transition nav-btn hover:bg-gray-700/50">
                联想批量生成
            </button>
            <button onclick="switchMainTab('library')" id="nav-library" class="px-6 py-3 rounded-lg bg-gray-800/50 text-sm font-medium transition nav-btn hover:bg-gray-700/50">
                模型库
            </button>
            <button onclick="switchMainTab('settings')" id="nav-settings" class="px-6 py-3 rounded-lg bg-gray-800/50 text-sm font-medium transition nav-btn hover:bg-gray-700/50">
                设置
            </button>
        </nav>

        <!-- Single Generation Panel -->
        <div id="panel-single" class="grid lg:grid-cols-2 gap-8">
            <!-- Left: Input Form -->
            <div class="card-gradient rounded-xl p-6 glow-border">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    单个模型生成
                </h2>

                <form id="generate-form" class="space-y-4">
                    <!-- Description -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">需求描述 *</label>
                        <textarea id="description" rows="4" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" placeholder="描述您想要生成的物品，例如：一台220kV的油浸式电力变压器，具有三个高压套管、波纹散热翅片和储油柜..." required></textarea>
                    </div>

                    <!-- Equipment Type & Voltage -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">设备类型</label>
                            <select id="equipment-type" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none">
                                <option value="">自动识别</option>
                                <option value="变压器">变压器</option>
                                <option value="断路器">断路器</option>
                                <option value="发电机">发电机</option>
                                <option value="电机">电机</option>
                                <option value="椅子">椅子</option>
                                <option value="桌子">桌子</option>
                                <option value="汽车">汽车</option>
                                <option value="机器人">机器人</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">电压等级</label>
                            <select id="voltage-level" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none">
                                <option value="">自动识别</option>
                                <option value="10kV">10kV</option>
                                <option value="35kV">35kV</option>
                                <option value="110kV">110kV</option>
                                <option value="220kV">220kV</option>
                                <option value="500kV">500kV</option>
                            </select>
                        </div>
                    </div>

                    <!-- 3D Config - Enhanced -->
                    <div class="bg-gray-800/30 rounded-lg p-4 space-y-4">
                        <h3 class="text-sm font-medium text-gray-300 mb-3">3D模型配置 (豆包Seed3D)</h3>

                        <!-- Subdivision Level -->
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">模型精度 (面数)</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="subdivision" value="low" class="sr-only peer">
                                    <div class="border border-gray-700 rounded-lg p-3 text-center peer-checked:border-blue-500 peer-checked:bg-blue-500/20 transition">
                                        <div class="font-medium">低精度</div>
                                        <div class="text-xs text-gray-500">~30k面</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="subdivision" value="medium" class="sr-only peer" checked>
                                    <div class="border border-gray-700 rounded-lg p-3 text-center peer-checked:border-blue-500 peer-checked:bg-blue-500/20 transition">
                                        <div class="font-medium">中等精度</div>
                                        <div class="text-xs text-gray-500">~100k面</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="subdivision" value="high" class="sr-only peer">
                                    <div class="border border-gray-700 rounded-lg p-3 text-center peer-checked:border-blue-500 peer-checked:bg-blue-500/20 transition">
                                        <div class="font-medium">高精度</div>
                                        <div class="text-xs text-gray-500">~200k面</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- File Format -->
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">输出格式</label>
                            <div class="grid grid-cols-4 gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="format" value="glb" class="sr-only peer" checked>
                                    <div class="border border-gray-700 rounded-lg p-2 text-center peer-checked:border-green-500 peer-checked:bg-green-500/20 transition text-sm">GLB</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="format" value="obj" class="sr-only peer">
                                    <div class="border border-gray-700 rounded-lg p-2 text-center peer-checked:border-green-500 peer-checked:bg-green-500/20 transition text-sm">OBJ</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="format" value="usd" class="sr-only peer">
                                    <div class="border border-gray-700 rounded-lg p-2 text-center peer-checked:border-green-500 peer-checked:bg-green-500/20 transition text-sm">USD</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="format" value="usdz" class="sr-only peer">
                                    <div class="border border-gray-700 rounded-lg p-2 text-center peer-checked:border-green-500 peer-checked:bg-green-500/20 transition text-sm">USDZ</div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submit-btn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-4 rounded-lg transition transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="btn-text">开始生成 3D 模型</span>
                        <span id="btn-loading" class="hidden">
                            <svg class="animate-spin inline w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            处理中...
                        </span>
                    </button>
                </form>

                <!-- Progress Steps -->
                <div id="progress-section" class="mt-8 hidden">
                    <h3 class="text-sm text-gray-400 mb-4">生成进度</h3>
                    <div class="space-y-3">
                        <div class="flex items-center" id="step-prompt">
                            <div class="w-8 h-8 rounded-full step-pending flex items-center justify-center mr-3 transition-all"><span class="text-sm">1</span></div>
                            <div><div class="font-medium">生成Prompt</div><div class="text-sm text-gray-500" id="step-prompt-status">等待中</div></div>
                        </div>
                        <div class="flex items-center" id="step-image">
                            <div class="w-8 h-8 rounded-full step-pending flex items-center justify-center mr-3 transition-all"><span class="text-sm">2</span></div>
                            <div><div class="font-medium">生成图像</div><div class="text-sm text-gray-500" id="step-image-status">等待中</div></div>
                        </div>
                        <div class="flex items-center" id="step-model">
                            <div class="w-8 h-8 rounded-full step-pending flex items-center justify-center mr-3 transition-all"><span class="text-sm">3</span></div>
                            <div><div class="font-medium">生成3D模型</div><div class="text-sm text-gray-500" id="step-model-status">等待中</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Preview -->
            <div class="card-gradient rounded-xl p-6 glow-border">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    预览
                </h2>

                <!-- Preview Tabs -->
                <div class="flex space-x-2 mb-4">
                    <button onclick="switchPreviewTab('prompt')" id="tab-prompt" class="px-4 py-2 rounded-lg bg-gray-800/50 text-sm hover:bg-gray-700/50 transition preview-tab">Prompt</button>
                    <button onclick="switchPreviewTab('image')" id="tab-image" class="px-4 py-2 rounded-lg bg-gray-800/50 text-sm hover:bg-gray-700/50 transition preview-tab">图像</button>
                    <button onclick="switchPreviewTab('model')" id="tab-model" class="px-4 py-2 rounded-lg tab-active border text-sm transition preview-tab">3D模型</button>
                </div>

                <!-- Prompt Preview -->
                <div id="preview-prompt" class="hidden">
                    <div class="bg-gray-800/50 rounded-lg p-4 h-[400px] overflow-auto">
                        <pre id="prompt-content" class="text-sm text-gray-300 whitespace-pre-wrap">生成后将在此显示 Prompt...</pre>
                    </div>
                </div>

                <!-- Image Preview -->
                <div id="preview-image" class="hidden">
                    <div class="bg-gray-800/50 rounded-lg p-4 h-[400px] flex items-center justify-center">
                        <img id="image-preview" src="" alt="Generated Image" class="max-h-full max-w-full rounded hidden">
                        <div id="image-placeholder" class="text-gray-500 text-center">
                            <svg class="w-16 h-16 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p>生成后将在此显示图像</p>
                        </div>
                    </div>
                </div>

                <!-- 3D Model Preview -->
                <div id="preview-model">
                    <div id="model-viewer">
                        <div id="model-placeholder" class="w-full h-full flex items-center justify-center text-gray-500">
                            <div class="text-center">
                                <svg class="w-16 h-16 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                                <p>生成后将在此显示3D模型</p>
                                <p class="text-sm mt-1">支持鼠标拖拽旋转、滚轮缩放</p>
                            </div>
                        </div>
                    </div>
                    <div id="model-controls" class="mt-4 hidden">
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-400"><span id="model-info"></span></div>
                            <button onclick="downloadModel()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm transition">下载模型</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Batch Generation Panel -->
        <div id="panel-batch" class="hidden">
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Left: Batch Config -->
                <div class="card-gradient rounded-xl p-6 glow-border">
                    <h2 class="text-xl font-semibold mb-6 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        联想批量生成
                    </h2>

                    <div class="space-y-4">
                        <!-- Category Input -->
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">物品类别 *</label>
                            <input type="text" id="batch-category" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-blue-500 outline-none" placeholder="输入类别，如：椅子、变压器、汽车...">
                            <p class="text-xs text-gray-500 mt-1">AI将自动联想该类别下多种不同样式的物品</p>
                        </div>

                        <!-- Quick Categories -->
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">快速选择</label>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="setBatchCategory('椅子')" class="px-3 py-1 bg-gray-700/50 rounded-lg text-sm hover:bg-gray-600/50 transition">椅子</button>
                                <button onclick="setBatchCategory('变压器')" class="px-3 py-1 bg-gray-700/50 rounded-lg text-sm hover:bg-gray-600/50 transition">变压器</button>
                                <button onclick="setBatchCategory('汽车')" class="px-3 py-1 bg-gray-700/50 rounded-lg text-sm hover:bg-gray-600/50 transition">汽车</button>
                                <button onclick="setBatchCategory('机器人')" class="px-3 py-1 bg-gray-700/50 rounded-lg text-sm hover:bg-gray-600/50 transition">机器人</button>
                                <button onclick="setBatchCategory('手机')" class="px-3 py-1 bg-gray-700/50 rounded-lg text-sm hover:bg-gray-600/50 transition">手机</button>
                            </div>
                        </div>

                        <!-- Generation Count -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">生成数量</label>
                                <select id="batch-count" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white">
                                    <option value="10">10个</option>
                                    <option value="20" selected>20个</option>
                                    <option value="30">30个</option>
                                    <option value="50">50个</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">并行数量</label>
                                <select id="batch-parallel" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white">
                                    <option value="1">1个</option>
                                    <option value="2">2个</option>
                                    <option value="3" selected>3个</option>
                                    <option value="5">5个</option>
                                </select>
                            </div>
                        </div>

                        <!-- Association Mode -->
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">联想模式</label>
                            <select id="batch-mode" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white">
                                <option value="comprehensive">综合联想 (推荐)</option>
                                <option value="style">按风格联想</option>
                                <option value="spec">按规格联想</option>
                                <option value="purpose">按用途联想</option>
                                <option value="material">按材质联想</option>
                            </select>
                        </div>

                        <!-- AI Provider -->
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">联想AI服务商</label>
                            <select id="batch-provider" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white">
                                <option value="deepseek">DeepSeek (推荐)</option>
                                <option value="kimi">Kimi (月之暗面)</option>
                                <option value="qwen">通义千问</option>
                                <option value="zhipu">智谱GLM</option>
                            </select>
                        </div>

                        <!-- 3D Config -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">3D精度</label>
                                <select id="batch-subdivision" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white">
                                    <option value="low">低精度 (~30k面)</option>
                                    <option value="medium" selected>中等 (~100k面)</option>
                                    <option value="high">高精度 (~200k面)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">输出格式</label>
                                <select id="batch-format" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white">
                                    <option value="glb" selected>GLB</option>
                                    <option value="obj">OBJ</option>
                                    <option value="usd">USD</option>
                                    <option value="usdz">USDZ</option>
                                </select>
                            </div>
                        </div>

                        <!-- Submit -->
                        <button onclick="startBatchGeneration()" id="batch-submit-btn" class="w-full bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-semibold py-4 rounded-lg transition">
                            开始联想批量生成
                        </button>
                    </div>
                </div>

                <!-- Right: Batch Progress -->
                <div class="card-gradient rounded-xl p-6 glow-border">
                    <h2 class="text-xl font-semibold mb-6">批量生成进度</h2>

                    <!-- Overall Progress -->
                    <div id="batch-progress-container" class="mb-6">
                        <div class="flex justify-between text-sm mb-2">
                            <span id="batch-progress-text">等待开始...</span>
                            <span id="batch-progress-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div id="batch-progress-bar" class="progress-bar bg-gradient-to-r from-orange-500 to-red-500 h-3 rounded-full" style="width: 0%"></div>
                        </div>
                        <div class="grid grid-cols-4 gap-2 mt-3 text-center text-xs">
                            <div class="bg-gray-800/50 rounded p-2">
                                <div id="batch-stat-total" class="text-lg font-bold">0</div>
                                <div class="text-gray-500">总数</div>
                            </div>
                            <div class="bg-gray-800/50 rounded p-2">
                                <div id="batch-stat-completed" class="text-lg font-bold text-green-400">0</div>
                                <div class="text-gray-500">完成</div>
                            </div>
                            <div class="bg-gray-800/50 rounded p-2">
                                <div id="batch-stat-running" class="text-lg font-bold text-blue-400">0</div>
                                <div class="text-gray-500">进行中</div>
                            </div>
                            <div class="bg-gray-800/50 rounded p-2">
                                <div id="batch-stat-failed" class="text-lg font-bold text-red-400">0</div>
                                <div class="text-gray-500">失败</div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Items -->
                    <div id="batch-items-container" class="space-y-2 max-h-[400px] overflow-auto">
                        <div class="text-gray-500 text-center py-8">
                            <p>联想生成的物品将在此显示</p>
                            <p class="text-sm">每个物品生成完成后会自动更新</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Library Panel -->
        <div id="panel-library" class="hidden">
            <div class="card-gradient rounded-xl p-6 glow-border">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold flex items-center">
                        <svg class="w-6 h-6 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        3D模型库
                    </h2>
                    <div class="flex items-center space-x-4">
                        <span id="library-stats" class="text-sm text-gray-400">加载中...</span>
                        <button onclick="refreshLibrary()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition">刷新</button>
                    </div>
                </div>

                <div id="library-grid" class="grid md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <div class="text-gray-500 text-center py-8 col-span-full">加载中...</div>
                </div>

                <!-- Pagination -->
                <div id="library-pagination" class="flex justify-center mt-6 space-x-2"></div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="panel-settings" class="hidden">
            <div class="card-gradient rounded-xl p-6 glow-border">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    AI服务商配置
                </h2>

                <div id="providers-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-gray-500 text-center py-8 col-span-full">加载服务商列表中...</div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="mt-8 card-gradient rounded-xl p-6" id="history-section">
            <h2 class="text-xl font-semibold mb-4">最近生成</h2>
            <div id="jobs-list" class="grid md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="text-gray-500 text-center py-8">暂无历史记录</div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentJobId = null;
        let currentModelUrl = null;
        let currentBatchId = null;
        let scene, camera, renderer, controls, model;

        // Main tab switching
        function switchMainTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500/20', 'border', 'border-blue-500');
                btn.classList.add('bg-gray-800/50');
            });
            document.getElementById(`nav-${tab}`).classList.add('bg-blue-500/20', 'border', 'border-blue-500');
            document.getElementById(`nav-${tab}`).classList.remove('bg-gray-800/50');

            ['single', 'batch', 'library', 'settings'].forEach(p => {
                document.getElementById(`panel-${p}`).classList.add('hidden');
            });
            document.getElementById(`panel-${tab}`).classList.remove('hidden');

            // Load data for specific tabs
            if (tab === 'library') refreshLibrary();
            if (tab === 'settings') loadProviders();
        }

        // Preview tab switching
        function switchPreviewTab(tab) {
            document.querySelectorAll('.preview-tab').forEach(btn => {
                btn.classList.remove('tab-active', 'border');
                btn.classList.add('bg-gray-800/50');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active', 'border');
            document.getElementById(`tab-${tab}`).classList.remove('bg-gray-800/50');

            ['prompt', 'image', 'model'].forEach(p => {
                document.getElementById(`preview-${p}`).classList.add('hidden');
            });
            document.getElementById(`preview-${tab}`).classList.remove('hidden');
        }

        // Form submission
        document.getElementById('generate-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const description = document.getElementById('description').value;
            const equipmentType = document.getElementById('equipment-type').value;
            const voltageLevel = document.getElementById('voltage-level').value;
            const subdivision = document.querySelector('input[name="subdivision"]:checked').value;
            const format = document.querySelector('input[name="format"]:checked').value;

            document.getElementById('submit-btn').disabled = true;
            document.getElementById('btn-text').classList.add('hidden');
            document.getElementById('btn-loading').classList.remove('hidden');
            document.getElementById('progress-section').classList.remove('hidden');
            resetSteps();

            try {
                const response = await fetch('/api/v1/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description,
                        equipment_type: equipmentType || null,
                        voltage_level: voltageLevel || null,
                        mesh_quality: subdivision
                    })
                });
                const result = await response.json();
                currentJobId = result.job_id;
                pollJobStatus(currentJobId);
            } catch (error) {
                alert('Request failed: ' + error.message);
                resetForm();
            }
        });

        // Poll job status
        async function pollJobStatus(jobId) {
            try {
                const response = await fetch(`/api/v1/jobs/${jobId}`);
                const status = await response.json();
                updateProgress(status);

                if (status.stage === 'completed') {
                    onJobCompleted(status);
                } else if (status.stage === 'failed') {
                    alert('Generation failed: ' + status.error);
                    resetForm();
                } else {
                    setTimeout(() => pollJobStatus(jobId), 2000);
                }
            } catch (error) {
                console.error('Status poll error:', error);
                setTimeout(() => pollJobStatus(jobId), 3000);
            }
        }

        function updateProgress(status) {
            const stage = status.stage;
            if (['prompt_generation', 'image_generation', 'model_generation', 'completed'].includes(stage)) {
                setStepStatus('prompt', stage === 'prompt_generation' ? 'active' : 'completed');
                if (status.prompt) document.getElementById('prompt-content').textContent = status.prompt;
            }
            if (['image_generation', 'model_generation', 'completed'].includes(stage)) {
                setStepStatus('image', stage === 'image_generation' ? 'active' : 'completed');
            }
            if (['model_generation', 'completed'].includes(stage)) {
                setStepStatus('model', stage === 'model_generation' ? 'active' : 'completed');
            }
        }

        function setStepStatus(step, status) {
            const stepEl = document.querySelector(`#step-${step} > div:first-child`);
            stepEl.classList.remove('step-pending', 'step-active', 'step-completed');
            stepEl.classList.add(`step-${status}`);
            if (status === 'completed') {
                stepEl.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
            }
        }

        function resetSteps() {
            ['prompt', 'image', 'model'].forEach((step, i) => {
                const stepEl = document.querySelector(`#step-${step} > div:first-child`);
                stepEl.classList.remove('step-active', 'step-completed');
                stepEl.classList.add('step-pending');
                stepEl.innerHTML = `<span class="text-sm">${i + 1}</span>`;
                document.getElementById(`step-${step}-status`).textContent = 'Waiting';
            });
        }

        function resetForm() {
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('btn-text').classList.remove('hidden');
            document.getElementById('btn-loading').classList.add('hidden');
        }

        async function onJobCompleted(status) {
            resetForm();
            if (status.prompt) document.getElementById('prompt-content').textContent = status.prompt;
            if (status.image_path) {
                const imgUrl = `/api/v1/jobs/${status.job_id}/image`;
                document.getElementById('image-preview').src = imgUrl;
                document.getElementById('image-preview').classList.remove('hidden');
                document.getElementById('image-placeholder').classList.add('hidden');
            }
            if (status.model_files && status.model_files.length > 0) {
                const glbFile = status.model_files.find(f => f.name.endsWith('.glb'));
                if (glbFile) {
                    const fileName = glbFile.name.split('/').pop();
                    currentModelUrl = `/api/v1/jobs/${status.job_id}/model/${fileName}`;
                    load3DModel(currentModelUrl);
                    document.getElementById('model-info').textContent = `File: ${fileName} (${(glbFile.size_bytes / 1024 / 1024).toFixed(1)} MB)`;
                    document.getElementById('model-controls').classList.remove('hidden');
                }
            }
            loadJobsList();
        }

        // 3D Model Viewer
        function init3DViewer() {
            const container = document.getElementById('model-viewer');
            const width = container.clientWidth;
            const height = container.clientHeight;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f172a);

            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(5, 3, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight2.position.set(-5, -10, -7.5);
            scene.add(directionalLight2);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer && scene && camera) renderer.render(scene, camera);
        }

        function load3DModel(url) {
            document.getElementById('model-placeholder').classList.add('hidden');
            if (!renderer) {
                init3DViewer();
                document.getElementById('model-viewer').appendChild(renderer.domElement);
            }
            if (model) scene.remove(model);

            const loader = new THREE.GLTFLoader();
            loader.load(url, (gltf) => {
                model = gltf.scene;
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                model.position.sub(center);
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 3 / maxDim;
                model.scale.setScalar(scale);
                scene.add(model);
                camera.position.set(5, 3, 5);
                controls.target.set(0, 0, 0);
                controls.update();
            }, undefined, (error) => console.error('Error loading model:', error));
        }

        function downloadModel() {
            if (currentModelUrl) {
                const a = document.createElement('a');
                a.href = currentModelUrl;
                a.download = 'model.glb';
                a.click();
            }
        }

        // Jobs list
        async function loadJobsList() {
            try {
                const response = await fetch('/api/v1/jobs');
                const jobs = await response.json();
                if (jobs.length === 0) {
                    document.getElementById('jobs-list').innerHTML = '<div class="text-gray-500 text-center py-8 col-span-full">No history</div>';
                    return;
                }
                const html = jobs.slice(0, 6).map(job => `
                    <div class="bg-gray-800/50 rounded-lg p-4 cursor-pointer hover:bg-gray-700/50 transition" onclick="loadJob('${job.job_id}')">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-mono text-gray-400">#${job.job_id}</span>
                            <span class="text-xs px-2 py-1 rounded ${job.stage === 'completed' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">${job.stage === 'completed' ? 'Done' : job.stage}</span>
                        </div>
                        <p class="text-sm text-gray-300 line-clamp-2">${job.description}</p>
                    </div>
                `).join('');
                document.getElementById('jobs-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        async function loadJob(jobId) {
            try {
                const response = await fetch(`/api/v1/jobs/${jobId}`);
                const status = await response.json();
                onJobCompleted(status);
            } catch (error) {
                console.error('Error loading job:', error);
            }
        }

        // Batch generation
        function setBatchCategory(category) {
            document.getElementById('batch-category').value = category;
        }

        async function startBatchGeneration() {
            const category = document.getElementById('batch-category').value;
            if (!category) {
                alert('Please enter a category');
                return;
            }

            const count = parseInt(document.getElementById('batch-count').value);
            const parallel = parseInt(document.getElementById('batch-parallel').value);
            const mode = document.getElementById('batch-mode').value;
            const provider = document.getElementById('batch-provider').value;
            const subdivision = document.getElementById('batch-subdivision').value;
            const format = document.getElementById('batch-format').value;

            document.getElementById('batch-submit-btn').disabled = true;
            document.getElementById('batch-submit-btn').textContent = 'Starting...';

            try {
                const response = await fetch('/api/v2/batch/from-association', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        association_request: {
                            category,
                            count,
                            mode,
                            provider
                        },
                        max_parallel: parallel,
                        subdivision_level: subdivision,
                        file_format: format
                    })
                });
                const result = await response.json();
                currentBatchId = result.batch_id;

                // Show preview items
                const itemsHtml = result.items_preview.map(item => `
                    <div class="bg-gray-800/50 rounded-lg p-3 slide-in">
                        <div class="font-medium text-sm">${item.name}</div>
                        <div class="text-xs text-gray-500 truncate">${item.description}</div>
                    </div>
                `).join('');
                document.getElementById('batch-items-container').innerHTML = itemsHtml;

                // Update stats
                document.getElementById('batch-stat-total').textContent = result.total;
                document.getElementById('batch-progress-text').textContent = `Association complete, generating ${result.total} models...`;

                // Start polling
                pollBatchStatus(currentBatchId);

            } catch (error) {
                alert('Failed to start batch: ' + error.message);
            } finally {
                document.getElementById('batch-submit-btn').disabled = false;
                document.getElementById('batch-submit-btn').textContent = 'Start Association Batch Generation';
            }
        }

        async function pollBatchStatus(batchId) {
            try {
                const response = await fetch(`/api/v2/batch/${batchId}/status`);
                const status = await response.json();

                // Update progress
                document.getElementById('batch-stat-total').textContent = status.total;
                document.getElementById('batch-stat-completed').textContent = status.completed;
                document.getElementById('batch-stat-running').textContent = status.running;
                document.getElementById('batch-stat-failed').textContent = status.failed;
                document.getElementById('batch-progress-percent').textContent = `${status.progress_percent.toFixed(1)}%`;
                document.getElementById('batch-progress-bar').style.width = `${status.progress_percent}%`;
                document.getElementById('batch-progress-text').textContent = `Completed ${status.completed}/${status.total}`;

                if (status.completed + status.failed < status.total) {
                    setTimeout(() => pollBatchStatus(batchId), 3000);
                } else {
                    document.getElementById('batch-progress-text').textContent = 'Batch generation complete!';
                }
            } catch (error) {
                console.error('Error polling batch status:', error);
                setTimeout(() => pollBatchStatus(batchId), 5000);
            }
        }

        // Library
        async function refreshLibrary() {
            try {
                // Get stats
                const statsResp = await fetch('/api/v2/library/stats');
                const stats = await statsResp.json();
                document.getElementById('library-stats').textContent = `Total ${stats.total_models} models (${stats.total_size_mb} MB)`;

                // Get models
                const response = await fetch('/api/v2/library/browse?page=1&page_size=12');
                const data = await response.json();

                if (data.models.length === 0) {
                    document.getElementById('library-grid').innerHTML = '<div class="text-gray-500 text-center py-8 col-span-full">No models yet</div>';
                    return;
                }

                const html = data.models.map(m => `
                    <div class="bg-gray-800/50 rounded-lg p-4 hover:bg-gray-700/50 transition cursor-pointer">
                        <div class="aspect-square bg-gray-900 rounded-lg mb-2 flex items-center justify-center">
                            <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                            </svg>
                        </div>
                        <div class="text-sm font-medium truncate">${m.name || m.id}</div>
                        <div class="text-xs text-gray-500 truncate">${m.description || ''}</div>
                    </div>
                `).join('');
                document.getElementById('library-grid').innerHTML = html;
            } catch (error) {
                console.error('Error loading library:', error);
            }
        }

        // Providers
        async function loadProviders() {
            try {
                const response = await fetch('/api/v2/providers');
                const providers = await response.json();

                const html = providers.map(p => `
                    <div class="bg-gray-800/50 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-medium">${p.display_name}</div>
                                <div class="text-xs text-gray-500">${p.provider_type}</div>
                            </div>
                            <span class="px-2 py-1 rounded text-xs ${p.is_configured ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'}">
                                ${p.is_configured ? 'Configured' : 'Not configured'}
                            </span>
                        </div>
                        <p class="text-sm text-gray-400 mb-2">${p.description}</p>
                        <div class="flex flex-wrap gap-1 mb-2">
                            ${p.capabilities.slice(0, 4).map(c => `<span class="px-2 py-0.5 bg-gray-700/50 rounded text-xs">${c.replace('_', ' ')}</span>`).join('')}
                        </div>
                        <a href="${p.api_doc_url}" target="_blank" class="text-xs text-blue-400 hover:underline">API Docs</a>
                    </div>
                `).join('');
                document.getElementById('providers-list').innerHTML = html;
            } catch (error) {
                document.getElementById('providers-list').innerHTML = '<div class="text-gray-500 text-center py-8 col-span-full">Failed to load providers</div>';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadJobsList();
        });
    </script>
</body>
</html>
